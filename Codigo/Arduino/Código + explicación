#include <SoftwareSerial.h> 
#include <Servo.h>

// ======================================================
// ===============  BLUETOOTH HC-05  =====================
// ======================================================
//
// El robot recibe Ã³rdenes desde un CELULAR por Bluetooth.
// El mÃ³dulo HC-05 le manda letras al Arduino.
// Este cableado permite que Arduino â€œescucheâ€ esas letras.
//
// HC-05 TX --> Pin 7 del Arduino  (Arduino recibe datos)
// HC-05 RX --> Pin 6 del Arduino  (Arduino envÃ­a datos)
//
// ATENCIÃ“N: RX siempre va con TX, y TX con RX.
//
SoftwareSerial BT(7, 6);  



// ======================================================
// ======================  BRAZOS  =======================
// ======================================================
//
// Este servo mueve los brazos del robot.
// Solo hay UN servo, conectado al pin 8.
//
Servo servoBrazos;  // Servo en el pin 8

// PosiciÃ³n inicial del brazo
int anguloBrazo = 60;
bool brazoEnCero = false;   // Sirve para alternar movimiento (toggle)


// ======================================================
// ===================  MOTORES DRV8833  =================
// ======================================================
//
// El robot tiene dos ruedas.
// Cada rueda se mueve con dos cables (IN1/IN2 e IN3/IN4).
//
// IN1 - IN2 controlan la RUEDA IZQUIERDA
// IN3 - IN4 controlan la RUEDA DERECHA
//
// HIGH/LOW cambian si gira para adelante o atrÃ¡s.
//
const int IN1 = 2;  // Izquierda
const int IN2 = 3;
const int IN3 = 4;  // Derecha
const int IN4 = 5;

// Para detener movimiento automÃ¡tico
bool moviendo = false;
unsigned long tiempoInicioMovimiento = 0;
const unsigned long TIEMPO_MOVIMIENTO_MS = 1000; // 1 segundo



// ======================================================
// =============== FUNCIONES DE LOS MOTORES ===============
// ======================================================
//
// Estas funciones hacen que el robot avance, retroceda, gire, etc.
//

// Apaga las dos ruedas
void detenerMotores() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
  moviendo = false;
}

// Las dos ruedas para ADELANTE
void avanzar() {
  // Rueda izquierda adelante
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);

  // Rueda derecha adelante
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);

  moviendo = true;
  tiempoInicioMovimiento = millis();
}

// Las dos ruedas para ATRÃS
void retroceder() {
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);

  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);

  moviendo = true;
  tiempoInicioMovimiento = millis();
}

// Girar DERECHA: solo rueda izquierda avanza
void girarDerecha() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);

  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);

  moviendo = true;
  tiempoInicioMovimiento = millis();
}

// Girar IZQUIERDA: solo rueda derecha avanza
void girarIzquierda() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);

  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);

  moviendo = true;
  tiempoInicioMovimiento = millis();
}



// ======================================================
// ==================  MOVER LOS BRAZOS ==================
// ======================================================
//
// Cada vez que se recibe la letra 'A', los brazos cambian
// entre dos posiciones (como si fueran ON/OFF).
//
void toggleBrazo() {
  if (brazoEnCero) {
    servoBrazos.write(60);   // posiciÃ³n 1
    brazoEnCero = false;
  } else {
    servoBrazos.write(0);    // posiciÃ³n 2
    brazoEnCero = true;
  }
}



// ======================================================
// ========================= SETUP =========================
// ======================================================
void setup() {

  // Configurar motores como salida
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);

  // Conectar el servo de los brazos al pin 8
  servoBrazos.attach(8);
  servoBrazos.write(anguloBrazo);

  // Iniciar la comunicaciÃ³n con Bluetooth
  Serial.begin(9600);
  BT.begin(9600);

  detenerMotores(); // Robot empieza quieto

  Serial.println("ðŸ¤– Robot listo para recibir comandos");

  Serial.println("COMANDOS:");
  Serial.println("  A = mover brazos");
  Serial.println("  C = avanzar");
  Serial.println("  B = retroceder");
  Serial.println("  D = girar derecha");
  Serial.println("  E = girar izquierda");
  Serial.println("  X/Y = detener");
}



// ======================================================
// ========================== LOOP ========================
// ======================================================
void loop() {

  // Si llega una letra desde la app de Bluetooth...
  if (BT.available()) {

    char cmd = BT.read();   // Leemos el comando
    Serial.print("Comando recibido: ");
    Serial.println(cmd);

    // ----- SERVOS -----
    if (cmd == 'A') {
      toggleBrazo();
    }

    // ----- MOTORES -----
    else if (cmd == 'C') {
      avanzar();
    }
    else if (cmd == 'B') {
      retroceder();
    }
    else if (cmd == 'D') {
      girarDerecha();
    }
    else if (cmd == 'E') {
      girarIzquierda();
    }
    else if (cmd == 'X' || cmd == 'Y') {
      detenerMotores();
    }
  }

  // Se detiene solo despuÃ©s de 1 segundo para seguridad
  if (moviendo && (millis() - tiempoInicioMovimiento >= TIEMPO_MOVIMIENTO_MS)) {
    detenerMotores();
    Serial.println("ðŸ›‘ Auto-freno (1 s)");
  }
}
