// ======== LIBRERÃAS ========
#include <Servo.h>
#include <SoftwareSerial.h>

// ======== BLUETOOTH ========
// BT conectado en: RX=11, TX=9
SoftwareSerial BT(11, 9);

// ======== SERVOS ========
Servo servoBrazos;  // Servo que mueve los brazos
Servo servoTorso;   // Servo que mueve el torso

// Posiciones iniciales
int anguloBrazo = 60;
int anguloTorso = 95;

// Para alternar el movimiento del brazo
bool brazoEnCero = false;

// ======== MOTORES (DRV8833) ========
// Motor izquierdo
#define IN1 5
#define IN2 4
// Motor derecho
#define IN3 3
#define IN4 2

// ======== VARIABLES ========
String comando = "";               // Guarda el comando recibido
bool moviendo = false;             // Si el robot estÃ¡ en movimiento
unsigned long tiempoInicioMovimiento = 0; // Para auto-frenado

// ======== FUNCIONES DE MOVIMIENTO ========

// Apaga todos los motores
void detenerMotores() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
  moviendo = false;
}

// Ambos motores para adelante
void avanzar() {
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
  moviendo = true;
  tiempoInicioMovimiento = millis();
}

// Ambos motores para atrÃ¡s
void retroceder() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
  moviendo = true;
  tiempoInicioMovimiento = millis();
}

// Gira a la derecha (solo motor izquierdo avanza)
void girarDerecha() {
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
  moviendo = true;
  tiempoInicioMovimiento = millis();
}

// Gira a la izquierda (solo motor derecho avanza)
void girarIzquierda() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
  moviendo = true;
  tiempoInicioMovimiento = millis();
}

// ======== SETUP ========
void setup() {
  Serial.begin(9600);   // Monitor serie
  BT.begin(9600);       // Bluetooth

  // Pines de motores como salida
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);

  // Conectar servos
  servoBrazos.attach(6);
  servoTorso.attach(7);

  // Posiciones iniciales
  servoBrazos.write(anguloBrazo);
  servoTorso.write(anguloTorso);

  detenerMotores();

  Serial.println("ğŸ¤– Robot listo para recibir comandos...");
}

// ======== LOOP PRINCIPAL ========
void loop() {

  // Si llegÃ³ un comando por Bluetooth...
  if (BT.available()) {
    comando = BT.readStringUntil('\n'); // Leer hasta salto de lÃ­nea
    comando.trim();                     // Sacar espacios
    comando.toUpperCase();              // Convertir todo a MAYÃšSCULA

    Serial.print("ğŸ“© Comando recibido: ");
    Serial.println(comando);

    // ======== SERVOS ========

    // Alternar brazo: comando "A"
    if (comando == "A") {
      if (brazoEnCero) {
        servoBrazos.write(60);
        brazoEnCero = false;
      } else {
        servoBrazos.write(0);
        brazoEnCero = true;
      }
    }

    // Alternar torso: comando "G"
    else if (comando == "G") {
      if (anguloTorso == 95) {
        servoTorso.write(60);
        anguloTorso = 60;
      } else {
        servoTorso.write(95);
        anguloTorso = 95;
      }
    }

    // ======== MOVIMIENTOS ========
    else if (comando == "B" || comando == "ABAJO") {
      retroceder();
    }
    else if (comando == "C" || comando == "ARRIBA") {
      avanzar();
    }
    else if (comando == "D" || comando == "DERECHA") {
      girarDerecha();
    }
    else if (comando == "E" || comando == "IZQUIERDA") {
      girarIzquierda();
    }
    else if (comando == "CENTRO X" || comando == "CENTRO Y") {
      detenerMotores();
    }
    else {
      Serial.println("âš ï¸ Comando no reconocido.");
    }
  }

  // ======== AUTO-FRENO ========
  // Si pasÃ³ mÃ¡s de 1 segundo moviÃ©ndose, se frena solo
  if (moviendo && (millis() - tiempoInicioMovimiento >= 1000)) {
    detenerMotores();
    Serial.println("ğŸ›‘ Motores detenidos automÃ¡ticamente despuÃ©s de 1 s");
  }
}
